use std::time::Duration;

use samod_core::{ConnectionId, DocumentId};

/// Events emitted by the Repo for observability.
#[non_exhaustive]
pub enum RepoEvent {
    /// A document actor was spawned.
    DocumentOpened {
        document_id: DocumentId,
    },
    /// A document actor was stopped.
    DocumentClosed {
        document_id: DocumentId,
    },

    /// A sync message was received and processed by a document actor.
    SyncMessageReceived {
        document_id: DocumentId,
        connection_id: ConnectionId,
        bytes: usize,
        duration: Duration,
    },
    /// A sync message was generated by a document actor.
    SyncMessageGenerated {
        document_id: DocumentId,
        connection_id: ConnectionId,
        bytes: usize,
        duration: Duration,
    },

    /// A storage operation completed.
    StorageOperationCompleted {
        operation: StorageOperation,
        duration: Duration,
    },

    /// The hub finished processing one event.
    HubEventProcessed {
        duration: Duration,
    },

    /// A new connection was created
    ConnectionEstablished {
        connection_id: ConnectionId,
    },

    ConnectionLost {
        connection_id: ConnectionId,
    },
}

/// Types of storage operations for metrics.
pub enum StorageOperation {
    Load,
    LoadRange,
    Put,
    Delete,
}

/// Trait for receiving structured observability events from the Repo.
///
/// Implement this trait and pass it to [`RepoBuilder::with_observer`] to
/// receive events about document lifecycle, peer connections, sync
/// processing, and storage operations.
pub trait RepoObserver: Send + Sync + 'static {
    fn observe(&self, event: &RepoEvent);
}
